<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta http-equiv="x-ua-compatible" content="IE=edge"></meta><meta name="format-detection" content="telephone=no"></meta><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"></meta><meta name="search" content="default"></meta><meta name="use.ic" content="no"></meta><meta name="tocstandalone" content="yes"></meta><meta name="theme" content="1"></meta><meta name="search.placeholder" content="Search"></meta><meta name="search.results" content="Search results"></meta><meta name="no.search.results" content="No results found"></meta><script type="text/javascript">
var theme = '1';

			
			var versionsfile = '';


			var indexDict = new Array();
			var store = {};
			var portalLanguage = 'en';
			var enterKey = 'select';
			
			
				var fuse_threshold = 0.3;
			
					var local_csh = false;
				
					var anchoroption = true;
				
			
			var useanchorlinks = false;
			
				useanchorlinks = true;
				
				var clicktocopy = 'Click to copy link';
				var linkcopied =  'Copied!';</script><title>Configure an IPSec Tunnel for an AWS Transit Gateway</title><link rel="stylesheet" type="text/css" href="../css/docbook.css"></link><link rel="stylesheet" type="text/css" href="../css/font-awesome.css"></link><link rel="stylesheet" type="text/css" href="../css/roboto.font.css"></link><link rel="stylesheet" type="text/css" href="../css/theme1.css"></link><link rel="stylesheet" type="text/css" href="../css/theme1-colors.css"></link><link rel="stylesheet" type="text/css" href="../css/content-theme2.css"></link><link rel="stylesheet" type="text/css" href="../css/sm-core-css.css"></link><link rel="stylesheet" type="text/css" href="../css/sm-simple.css"></link><link rel="stylesheet" type="text/css" href="../css/style-print.css"></link><link rel="stylesheet" type="text/css" href="../css/style-common.css"></link><link rel="stylesheet" type="text/css" href="../css/style-modern-tables.css"></link><link rel="stylesheet" type="text/css" href="../css/rwd-table.min.css"></link><link rel="stylesheet" type="text/css" href="../css/graphical-lists.css"></link><link rel="stylesheet" type="text/css" href="../css/layout-custom-style.css"></link><script src="../js/jquery-3/jquery-3.4.1.min.js" type="text/javascript"></script><script src="../js/jquery-migrate-3.0.1.min.js" type="text/javascript"></script><script src="../js/materialize.min.js" type="text/javascript"></script><script src="../js/bootstrap.min.js" type="text/javascript"></script><script src="../js/purl.js" type="text/javascript"></script><script src="../js/jquery.smartmenus.js" type="text/javascript"></script><script src="js/toc.js" type="text/javascript"></script><script src="../js/create-toc.js" type="text/javascript"></script><script src="../js/html5-2-mp-common.js" type="text/javascript"></script><script src="../js/html5-2.js" type="text/javascript"></script><script src="../js/checklist.js" type="text/javascript"></script><script src="../js/rwd-table.min.js" type="text/javascript"></script><script src="../js/responsive-tables.js" type="text/javascript"></script><script src="../js/clipboard.min.js" type="text/javascript"></script><script src="../js/anchorlinks.js" type="text/javascript"></script><script src="../js/lunr.js" type="text/javascript"></script><script src="../js/jquery.mark.min.js" type="text/javascript"></script><script src="js/data.js" type="text/javascript"></script><script src="../js/search.js" type="text/javascript"></script><script src="../js/csh.js" type="text/javascript"></script><script src="../js/jquery.paligocode.js" type="text/javascript"></script><script src="../js/layout-custom-script.js" type="text/javascript"></script><meta name="generator" content="Paligo"></meta><link rel="prev" href="configure-an-ipsec-tunnel-for-an-aws-virtual-private-gateway.html#UUID-a9b769af-5838-4a9b-5f74-8839ae299381_section-idm450121045012323265703194371" title="Configure an IPSec Tunnel for an AWS Virtual Private Gateway"></link><link rel="next" href="configure-an-ipsec-tunnel-for-an-aws-transit-gateway.html#UUID-1c6d8fc8-71aa-ad02-3f0b-ef043b2b6921_section-idm4554823043171232657271754817" title="Prerequisites"></link><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML" async="async"></script><link rel="icon" href="/favicon.ico" type="image/x-icon"></link><script type="text/javascript">var containerid = 'GTM-W56WJ8S';

						(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
						new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
						j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
						'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
						})(window,document,'script','dataLayer',containerid);
					</script><script type="text/javascript">
				$(document).ready(function () {
				$(".mediaobject img").addClass('materialboxed');
				//Exclude images with links
				$(".mediaobject a img").removeClass('materialboxed');
				if (!document.documentMode) {
				$('.materialboxed').materialbox();
				}});
			</script></head><body class="theme1 fixed-toolbar colored-top page-toc collapsible-sidebar-nav current-toc-section-focus" data-spy="scroll" data-target=".section-nav-container" data-offset="100" data-link-prefix=""><header class="site-header"><nav class="site-header-navbar navbar navbar-fixed-top"><div class="navbar-container"><div class="navbar-header"><button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".site-sidebar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><div id="logotype-container" class="pull-left"><a class="navbar-brand" href="../index.html?lang=en"><img id="logotype-pageheader" src="../css/image/corporate-logo.png" alt="Corporate logotype" data-role="logotype" class="logo"></img></a></div></div><div id="navbar" class="navbar-collapse collapse"></div></div></nav></header><div class="site-body"><div class="site-body-container"><div class="site-body-row"><aside class="site-sidebar"><div class="site-sidebar-header"><button type="button" class="navbar-toggle" aria-controls="nav-site-sidebar"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="../index.html?lang=en"><img id="logotype-pageheader" src="../css/image/corporate-logo.png" alt="Corporate logotype" data-role="logotype" class="logo"></img></a></div><form class="site-sidebar-search" autocomplete="off"><input type="text" class="form-control search-field" placeholder="Search" id="aa-search-input"></input></form><div id="toc-standalone-placeholder"></div></aside><div class="site-content"><h1 class="publication-title">Netskope Help</h1><div class="toolbar"><div class="toolbar-tools"><div id="navbar" class="navbar-collapse collapse"></div><div class="tool-print print-icon"><a onclick="window.print();return false;"><i class="fa fa-print" aria-hidden="true"><span class="print-text">print</span></i></a></div><div class="tool-search"><i class="fa fa-search" aria-hidden="true"></i></div><button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".site-sidebar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button></div><div class="breadcrumb-container"><ul class="breadcrumb"><li class="breadcrumb-link"> <a href="index-en.html">Netskope Help</a></li><li class="breadcrumb-link"><a href="integrations.html">Integrations</a></li><li class="breadcrumb-link"><a href="ipsec-and-gre.html">IPSec and GRE</a></li><li class="breadcrumb-link"><a href="netskope-ipsec-with-amazon-web-services.html">Netskope IPSec with Amazon Web Services</a></li><li class="breadcrumb-node">Configure an IPSec Tunnel for an AWS Transit Gateway</li></ul></div></div><main><div id="top-pager"><ul class="pager"><li class="previous"><a accesskey="p" id="header-navigation-prev" class="pull-left prev visible-lg visible-md" href="configure-an-ipsec-tunnel-for-an-aws-virtual-private-gateway.html#UUID-a9b769af-5838-4a9b-5f74-8839ae299381_section-idm450121045012323265703194371">Prev</a></li><li class="next"><a accesskey="n" id="header-navigation-next" class="pull-right next visible-lg visible-md" href="configure-an-ipsec-tunnel-for-an-aws-transit-gateway.html#UUID-1c6d8fc8-71aa-ad02-3f0b-ef043b2b6921_section-idm4554823043171232657271754817">Next</a></li></ul></div><article class="topic content-container" id="content-wrapper"><div id="topic-content" class="topic-content"><section xml:lang="en" lang="en" dir="ltr" class="section" data-origin-id="UUID-c1989b12-73ea-516c-901a-6c552222ebdc" data-permalink="configure-an-ipsec-tunnel-for-an-aws-transit-gateway.html" data-topic-level="1" data-relative-prefix="" data-time-modified="September 30, 2021" data-publication-date="" id="UUID-1c6d8fc8-71aa-ad02-3f0b-ef043b2b6921"><div class="titlepage"><div><div class="title"><h5 class="title">Configure an IPSec Tunnel for an AWS Transit Gateway</h5></div></div></div><p>This guide illustrates how to configure IPsec VPN tunnels between your AWS Transit Gateway and Netskope POPs. You must configure four VPN Tunnels in the Netskope UI for two AWS Site-to-Site VPNs.</p><p>This deployment ensures high availability of the site-to-site VPN connection if the AWS Availability Zone fails or a Netskope POP becomes unavailable.</p><section dir="ltr" class="section" data-origin-id="" data-publication-date="" id="UUID-1c6d8fc8-71aa-ad02-3f0b-ef043b2b6921_section-idm4554823043171232657271754817"><div class="titlepage"><div><div class="title"><h6 class="title">Prerequisites</h6></div></div></div><p>Before configuring an IPSec tunnel, ensure you have the following:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>An AWS account</p></li><li class="listitem"><p>An AWS IAM user or role with permissions to manage Amazon VPC resources (e.g., AWS Site-to-Site VPN, VPC route tables, and AWS Transit Gateway)</p></li><li class="listitem"><p>An Amazon VPC with corresponding subnets and route tables</p></li><li class="listitem"><p>An AWS Transit Gateway with corresponding route table</p></li><li class="listitem"><p>Access and permissions to manage IPSec VPN tunnels in the Netskope UI</p></li></ul></div></section><section xml:lang="en" lang="en" dir="ltr" class="section accordion accordion" data-origin-id="UUID-9c106656-3604-637e-e051-3f6e4b4af53f" data-time-modified="September 30, 2021" data-publication-date="" id="UUID-ee958858-31c5-34f8-1f33-a4e5860f1692"><div class="accordion-icon"></div><div class="panel panel-default"><div class="panel-heading"><div class="titlepage"><a data-toggle="collapse" href="#UUID-ee958858-31c5-34f8-1f33-a4e5860f1692_body" data-parent="#UUID-ee958858-31c5-34f8-1f33-a4e5860f1692"><div><div class="title"><h6 class="title">Configure an IPSec Tunnel for an AWS Transit Gateway</h6></div></div></a></div></div><div class="panel-body collapse" id="UUID-ee958858-31c5-34f8-1f33-a4e5860f1692_body"><p>To configure an IPsec VPN tunnel between your AWS Transit Gateway and Netskope POP:</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>In the Netskope UI, go to <span class="bold bold"><strong>Settings</strong></span> &gt; <span class="bold bold"><strong>Security Cloud Platform</strong></span> &gt; <span class="bold bold"><strong>IPSec</strong></span> and click <span class="bold bold"><strong>Add New IPSec Tunnel</strong></span>.</p><p>Enter a tunnel name and choose your primary and failover POP. Because you are creating four VPN tunnels in the Netskope UI, Netskope recommends choosing an appropriate naming convention. In this example, <code class="literal">AWSTGW1</code> is the AWS Transit Gateway name that this connection will be connected to, <code class="literal">NYC1</code> is the primary Netskope POP, and <code class="literal">A</code> corresponds to the first of two AWS Site-to-Site VPN connections are creating.</p><p>Copy the IP addresses of the Netskope POPs and leave the window open.</p><div class="mediaobject"><img src="image/uuid-17ea1a68-5bbe-62f3-4f9c-f29f39670376.png" style="" alt="image21.png"></img></div></li><li class="step"><p>Use the Netskope POP IP addresses to configure <a class="link" href="https://docs.aws.amazon.com/vpn/latest/s2svpn/your-cgw.html" target="_blank" rel="noopener">Customer Gateways</a> on your AWS account.</p><p>In the AWS UI, choose the VPC service, and go to <span class="bold bold"><strong>VIRTUAL PRIVATE NETWORK (VPN)</strong></span> &gt; <span class="bold bold"><strong>Customer Gateways</strong></span>. Click on <span class="bold bold"><strong>Create Customer Gateway</strong></span> and enter the primary Netskope POP name and IP address. Click <span class="bold bold"><strong>Create Customer Gateway</strong></span>.</p><div class="mediaobject"><img src="image/uuid-5710158c-9aae-b1a3-6f36-5dbb86ee552b.png" style="" alt="image6.png"></img></div></li><li class="step"><p>Repeat Step 2 to create the Customer Gateway for the failover Netskope POP.</p></li><li class="step"><p>Configure the VPN Connection:</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>In the AWS VPC UI, go to <span class="bold bold"><strong>VIRTUAL PRIVATE NETWORK (VPN)</strong></span> &gt; <span class="bold bold"><strong>Site-to-Site VPN Connections</strong></span>. Click <span class="bold bold"><strong>Create VPN Connection</strong></span>.</p></li><li class="step"><p>Enter the connection name.</p></li><li class="step"><p>Change <span class="bold bold"><strong>Target Gateway Type</strong></span> to <span class="bold bold"><strong>Transit Gateway</strong></span>.</p></li><li class="step"><p>Choose your <span class="bold bold"><strong>Transit Gateway</strong></span> from the drop-down menu.</p></li><li class="step"><p>Choose the primary Netskope <span class="bold bold"><strong>Customer Gateway ID</strong></span> from the drop-down menu.</p></li><li class="step"><p>Change <span class="bold bold"><strong>Routing Options</strong></span> to <span class="bold bold"><strong>Static</strong></span>.</p></li><li class="step"><p>Leave the Local IPv4 CIDR as the default <span class="bold bold"><strong>0.0.0.0/0</strong></span>.</p></li><li class="step"><p>(Optional) You can limit AWS IP addresses that are allowed to communicate over the tunnel by defining them in the Remote IPv4 Network CIDR. Default prefix 0.0.0.0/0 allows any AWS service and application to send packets over the tunnel based on your routing rules.</p><div class="mediaobject"><img src="image/uuid-85355e04-a196-7cc7-2531-473a5318544c.png" style="" alt="image22.png"></img></div></li><li class="step"><p>In <span class="bold bold"><strong>Tunnel Options</strong></span>, click <span class="bold bold"><strong>Edit Tunnel 1 Options</strong></span>, and change <span class="bold bold"><strong>DPD Timeout Action</strong></span> to <span class="bold bold"><strong>Restart</strong></span> and <span class="bold bold"><strong>Startup Action</strong></span> to <span class="bold bold"><strong>Start</strong></span>.</p><div class="mediaobject"><img src="image/uuid-2da2bf70-9413-cd67-8937-b5da05f51227.png" style="" alt="image11.png"></img></div></li><li class="step"><p>Click <span class="bold bold"><strong>Edit Tunnel 2 Options</strong></span>, and change <span class="bold bold"><strong>DPD Timeout Action</strong></span> to <span class="bold bold"><strong>Restart</strong></span> and <span class="bold bold"><strong>Startup Action</strong></span> to <span class="bold bold"><strong>Start</strong></span>.</p></li><li class="step"><p>Click <span class="bold bold"><strong>Create VPN Connection</strong></span> and then <span class="bold bold"><strong>Close</strong></span>.</p></li><li class="step"><p>In the Site-to-Site VPN connection window, choose the VPN connection you created, and click <span class="bold bold"><strong>Download Configuration</strong></span>.</p><p>Choose the<span class="bold bold"><strong> Generic Vendor</strong></span> from the drop-down menu, and click <span class="bold bold"><strong>Download</strong></span>.</p><div class="mediaobject"><img src="image/uuid-4acc7d77-d8ee-30ca-b5bc-fc58de237cee.png" style="" alt="image12.png"></img></div></li></ol></div></li><li class="step"><p>Repeat Step 4 to configure the failover Site-to-Site VPN changing the <span class="bold bold"><strong>Customer Gateway ID</strong></span> to the one you defined for the failover Netskope POP.</p></li><li class="step"><p>Finish the IPSec Tunnel configuration in the Netskope UI:</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>Open the AWS Site-to-Site VPN configuration file for the primary AWS Site-to-Site VPN connection you downloaded in Step 4l.</p></li><li class="step"><p>Copy the <span class="bold bold"><strong>Pre-Shared Key</strong></span> for IPSec Tunnel #1 in the configuration file.</p><div class="mediaobject"><img src="image/uuid-e1bea366-e545-df93-6421-885770f1cd47.png" style="" alt="image13.png"></img></div><p>In the Netskope UI, enter it in <span class="bold bold"><strong>Pre-Shared Key (PSK)</strong></span>.</p><div class="mediaobject"><img src="image/uuid-36be9070-bde3-3aa8-1941-8a414ad6f26b.png" style="" alt="image23.png"></img></div></li><li class="step"><p>In the configuration file, copy the <span class="bold bold"><strong>Virtual Private Gateway</strong></span> IP address for IPSec Tunnel #1.</p><div class="mediaobject"><img src="image/uuid-514e0052-ceff-0cb5-c034-42c302e0942a.png" style="" alt="image15.png"></img></div><p>In the Netskope UI, enter it in <span class="bold bold"><strong>Source Identity</strong></span>.</p><div class="mediaobject"><img src="image/uuid-7c7a3b28-c140-6ae1-65eb-7dc406924779.png" style="" alt="image24.png"></img></div></li><li class="step"><p>Click <span class="bold bold"><strong>Add</strong></span>.</p></li></ol></div></li><li class="step"><p>Configure the second VPN tunnel in the Netskope management console.</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>Repeat Step 1 and choose the same primary and failover Netskope POPs.</p></li><li class="step"><p>Repeat the Step 6 and use the <span class="bold bold"><strong>Pre-Shared Key</strong></span> for IPSec Tunnel #2 and the <span class="bold bold"><strong>Virtual Private Gateway</strong></span> IP address from the first AWS Site-to-Site VPN configuration file.</p></li></ol></div></li><li class="step"><p>Configure the third and fourth VPN tunnels in the Netskope UI.</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>Repeat Step 1 and reverse the primary and failover Netskope POPs.</p></li><li class="step"><p>Repeat Step 6 using the <span class="bold bold"><strong>Pre-Shared Keys</strong></span> for IPSec Tunnel #1 and #2, <span class="bold bold"><strong>Virtual Private Gateway</strong></span> IP addresses from the second AWS Site-to-Site VPN configuration file.</p></li></ol></div><p>At this point, you have configured two AWS Site-to-Site VPN connections, each associated with two tunnels and four corresponding VPN tunnels in the Netskope UI.</p></li><li class="step"><p>Check the status of the VPN tunnels in the Netskope UI and assure all four tunnels are up.</p><div class="mediaobject"><img src="image/uuid-045f8495-0df8-7960-a69f-cea7b2e16189.png" style="" alt="image25.png"></img></div></li><li class="step"><p>In the AWS VPC UI go to <span class="bold bold"><strong>VIRTUAL PRIVATE NETWORK (VPN)</strong></span> &gt; <span class="bold bold"><strong>Site-to-Site VPN Connections</strong></span>. For each configured connection, select the connection and click the <span class="bold bold"><strong>Tunnel Details</strong></span> tab to verify that the status of all four tunnels are up.</p><div class="mediaobject"><img src="image/uuid-b2d88669-489f-855a-de07-65b775d09068.png" style="" alt="image26.png"></img></div></li></ol></div></div></div></section><section xml:lang="en" lang="en" dir="ltr" class="section accordion accordion" data-origin-id="UUID-a5c42e27-7a96-2b9e-0ffe-3f55dcadd3dd" data-time-modified="October 4, 2021" data-publication-date="" id="UUID-7085f65b-116f-9fd5-9345-38a6c3b48aec"><div class="accordion-icon"></div><div class="panel panel-default"><div class="panel-heading"><div class="titlepage"><a data-toggle="collapse" href="#UUID-7085f65b-116f-9fd5-9345-38a6c3b48aec_body" data-parent="#UUID-7085f65b-116f-9fd5-9345-38a6c3b48aec"><div><div class="title"><h6 class="title">Configure a Transit Gateway Route Table</h6></div></div></a></div></div><div class="panel-body collapse" id="UUID-7085f65b-116f-9fd5-9345-38a6c3b48aec_body"><p>In an AWS Site-to-Site VPN connection for a single VPC (<a class="link" href="configure-an-ipsec-tunnel-for-an-aws-virtual-private-gateway.html" title="Configure an IPSec Tunnel for an AWS Virtual Private Gateway">AWS Virtual Private Gateway</a>), routing is controlled by the static routes in the AWS Site-to-Site VPN connection and the VPC route table associated with the VPC egress subnet. In an AWS Site-to-Site VPN connection with an AWS Transit Gateway, egress routing for a specific VPC is controlled by the transit gateway route table associated with the transit gateway VPC attachment and the VPC route table for the egress subnet.</p><p>If your AWS Transit Gateway has the default route table, default route table association, and propagation enabled, the transit gateway attachments, which are created automatically when you created the AWS Site-to-Site VPN connections for the AWS Transit Gateway, are associated with the default route table. Otherwise, the transit gateway VPN attachments won't have a route table associated with them. Regardless, Netskope recommends associating a separate transit gateway route table with the Netskope transit gateway VPN attachments (see the <a class="link" href="netskope-ipsec-with-amazon-web-services.html" title="Netskope IPSec with Amazon Web Services">high availability architecture diagram for an AWS Transit Gateway</a>).</p><div class="procedure" id="UUID-7085f65b-116f-9fd5-9345-38a6c3b48aec_procedure-idm4501210436915232658705596424"><ol class="procedure" type="1"><li class="step"><p>(Optional) Assign the names for new TGW VPN attachments.</p><p>When you created two AWS Site-to-Site VPN connections for your AWS Transit Gateway, AWS automatically created two transit gateway VPN attachments. Netskope recommends assigning the names for these attachments so you can easily identify them.</p><p>In the AWS VPC UI go to <span class="bold bold"><strong>TRANSIT GATEWAYS</strong></span> &gt; <span class="bold bold"><strong>Transit Gateways Attachments</strong></span>. Select the first VPN attachment with the empty <span class="bold bold"><strong>Name</strong></span> column. In the <span class="bold bold"><strong>Details</strong></span> tab, right-click the <span class="bold bold"><strong>Resource ID</strong></span> to open the link in a new window.</p><div class="mediaobject"><img src="image/uuid-b2f07186-7158-b5bd-e293-8875b8019f8c.png" style="" alt="image27.png"></img></div><p>On the <span class="bold bold"><strong>VPN Connection</strong></span> page, copy the name of the associated VPN connection:</p><div class="mediaobject"><img src="image/uuid-96b6bacd-c043-0d4a-7dd8-7f81f69c8429.png" style="" alt="image28.png"></img></div><p>In the <span class="bold bold"><strong>Transit Gateway Attachment</strong></span> page, edit the <span class="bold bold"><strong>Name</strong></span> column and paste the VPN connection name you copied. This allows you to easily identify the associated Netskope POP and AWS Transit Gateway:</p><div class="mediaobject"><img src="image/uuid-92926b73-d6f4-1178-e313-d119affbc198.png" style="" alt="image29.png"></img></div></li><li class="step"><p>Create a transit gateway route table for transit gateway VPN attachments.</p><p>Go to <span class="bold bold"><strong>TRANSIT GATEWAYS</strong></span> &gt; <span class="bold bold"><strong>Transit Gateways Route Tables</strong></span>. Click <span class="bold bold"><strong>Create Transit Gateways Route Table</strong></span>.</p><p>Enter a route table name, choose your AWS Transit Gateway from the drop-down menu, and click <span class="bold bold"><strong>Create Transit Gateways Route Table</strong></span>.</p><div class="mediaobject"><img src="image/uuid-5f891012-7527-2118-b01d-dea1291c4695.png" style="" alt="image30.png"></img></div></li><li class="step"><p>Associate the transit gateway route table with your Netskope transit gateway VPN attachments.</p><p>On the <span class="bold bold"><strong>Transit Gateways Route Tables</strong></span> page, select the route table you created. Click the <span class="bold bold"><strong>Associations</strong></span> tab and then <span class="bold bold"><strong>Create association</strong></span>. Choose the first transit gateway VPN attachment from the drop-down menu, and click <span class="bold bold"><strong>Create association</strong></span>.</p><div class="mediaobject"><img src="image/uuid-29e7bf73-b05c-1407-12e2-cc16fe49b3da.png" style="" alt="image31.png"></img></div><p>Click the <span class="bold bold"><strong>Create association</strong></span> tab again and repeat the steps to create an association for the second transit gateway VPN attachment.</p></li><li class="step"><p>Configure a route propagation from your VPC to your transit gateway route table.</p><p>On the <span class="bold bold"><strong>Transit Gateways Route Tables</strong></span> page, select the route table that you configured an association for. Click the <span class="bold bold"><strong>Propagations</strong></span> tab and then <span class="bold bold"><strong>Create propagation</strong></span>. Choose the transit gateway VPN attachment for your VPC, and click <span class="bold bold"><strong>Create propagation</strong></span>.</p><div class="mediaobject"><img src="image/uuid-b72a4fd5-1cf8-a416-fdb1-5e53189721c1.png" style="" alt="image32.png"></img></div></li><li class="step"><p>On the <span class="bold bold"><strong>Transit Gateways Route Tables</strong></span> page, select the route table that you configured a propagation for. Click the <span class="bold bold"><strong>Routes</strong></span> tab and ensure your VPN routes are propagated.</p><div class="mediaobject"><img src="image/uuid-71f54251-bdba-ede4-c472-8d45838f157f.png" style="" alt="image33.png"></img></div></li><li class="step"><p>This guides assumes you have TGW route table associated with your VPC. It also assumes your egress VPC subnet route table has a static route for the egress traffic pointing to your AWS Transit Gateway.</p><p>If you’re using a new VPC for testing, or you want to isolate a specific VPC for egress traffic testing with Netskope, create a transit gateway route table and associate it with the corresponding transit gateway VPC attachment. To learn more, see the <a class="link" href="https://docs.aws.amazon.com/vpc/latest/tgw/tgw-route-tables.html" target="_blank" rel="noopener">Amazon VPC documentation</a>.</p></li><li class="step"><p>Create a static route for the egress traffic in the transit gateway route table.</p><p>In AWS VPC UI,  go to <span class="bold bold"><strong>TRANSIT GATEWAYS</strong></span> &gt; <span class="bold bold"><strong>Transit Gateways Route Tables</strong></span>, and select the route table associated with your VPC. Click the <span class="bold bold"><strong>Routes</strong></span> tab and click <span class="bold bold"><strong>Create static route</strong></span>.</p><p>Enter the egress static route (e.g., 0.0.0.0/0), and choose the transit gateway VPN attachment for the primary Netskope POP. Click <span class="bold bold"><strong>Create static route</strong></span>.</p><div class="mediaobject"><img src="image/uuid-3acdb111-d85a-4145-9e24-4a4348760567.png" style="" alt="image34.png"></img></div><p>Repeat this step for each VPC you’d like to integrate with the Netskope cloud. Netskope recommends automating this step with your CloudOps orchestration tools for VPC provisioning.</p></li></ol></div><div dir="ltr" class="note"><h3 class="title">Note</h3><p>Only a single static route to the Netskope POP must be present in the transit gateway route table. If the AWS Availability Zone fails, the above configuration will be available. However, if the Netskope primary POP is unavailable, you must manually intervene.</p></div></div></div></section><section xml:lang="en" lang="en" dir="ltr" class="section accordion accordion" data-origin-id="UUID-7d39e8cb-629c-1fd2-d8db-f6306d7bfe41" data-time-modified="October 8, 2021" data-publication-date="" id="UUID-189a72ab-b534-fde4-6405-c46668613fc0"><div class="accordion-icon"></div><div class="panel panel-default"><div class="panel-heading"><div class="titlepage"><a data-toggle="collapse" href="#UUID-189a72ab-b534-fde4-6405-c46668613fc0_body" data-parent="#UUID-189a72ab-b534-fde4-6405-c46668613fc0"><div><div class="title"><h6 class="title">Configure Failover Automation for the AWS Transit Gateway</h6></div></div></a></div></div><div class="panel-body collapse" id="UUID-189a72ab-b534-fde4-6405-c46668613fc0_body"><p>To automate traffic failover from Netskope primary POP to the failover one, you must deploy the <a class="link" href="https://github.com/netskopeoss/AWS-TGW-IPsec-Automation" target="_blank" rel="noopener">Netskope AWS Transit Gateway Management solution</a>. This Netskope solution deploys AWS Lambda that's been triggered by the CloudWatch event rule for IPSec tunnel status changes. When called by the CloudWatch event rule, AWS Lambda checks if both tunnels to the Netskope POP are down. If so, it scans all the transit gateway route tables for the static route pointing to the transit gateway VPN attachments and corresponding AWS Site-to-Site VPN connections and replaces them with the alternative static route to the failover Netskope POP.  </p><p>You must deploy the Netskope solution in the US-West-2 region and enable the <a class="link" href="https://aws.amazon.com/transit-gateway/network-manager/" target="_blank" rel="noopener">AWS Transit Gateway Network Manager</a>. The AWS Transit Gateway Network Manager is the global AWS service that monitors the status of IPSec Site-to-Site VPN connections and uses Amazon CloudWatch in the US-West-2 region for alerting and logging. The Netskope solution uses AWS Transit Gateway events in the US-West-2 region to monitor your transit gateway in any region on the same account. However, cross-account monitoring is not supported. You also must deploy one Netskope AWS Transit Gateway Management instance per transit gateway. You can customize AWS Lambda to work with multiple transit gateways or treat a group of transit gateway attachments differently. </p><p>The Netskope solution assumes all transit gateway VPC attachments have the static route pointing to the same VPN attachments. Therefore, all VPCs connected to your AWS Transit Gateway utilize the same IPSec tunnel between the transit gateway and Netskope POP. Each tunnel is limited to 250 Mbps of bandwidth. To scale the Netskope solution, you can split your VPCs to a number of groups and route traffic for each group for its own redundant IPsec Site-to-Site VPN connections. You can customize AWS Lambda to support this option. You also can enable or disable the fallback functionality. If enabled, AWS Lambda will revert static routes to the primary Netskope POP when both of the IPSec tunnels are up.</p><p>In addition to checking and updating routes when the IPSec tunnel status changes, AWS Lambda triggers every 10 minutes and checks if there are any routes left pointing to the inactive IPSec tunnel. This prevents a an execution time out where the IPSec connections are intensively bouncing and cause a race condition between the AWS Lambda executions. To prevent inconsistent results, only one AWS Lambda execution can run at a time. To control concurrency, you can use Amazon DynamoDB, which is created as part of the Netskope solution deployment.
</p><p>The AWS CloudFormation stack creates the IAM role for AWS Lambda. CloudFormation implements the role based on the least privilege access control model. To limit access only to transit gateway attachments and route tables that belong to the transit gateway, CloudFormation uses the IAM policy condition that checks the tags associated with the transit gateway attachments. You must tag each of your transit gateway attachments with the tag <code class="literal">"Key"="TGWName", "Value"="&lt;Transit Gateway Name&gt;"</code>. Replace <code class="literal">&lt;Transit Gateway Name&gt;</code> with the name of yours. For example, <code class="literal">"Key"="TGWName", "Value"="NSTGW-us-east-1"</code>.</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>Clone the <a class="link" href="https://github.com/netskopeoss/AWS-TGW-IPsec-Automation" target="_blank" rel="noopener">Netskope AWS Transit Gateway Management repository</a>.</p><div dir="ltr" class="note"><h3 class="title">Note</h3><p>If don't plan to modify AWS Lambda, you can deploy this solution using <code class="literal">TGW_IPsec_management.yaml</code>, which is a CloudFormation template that deploys AWS Lambda from the Netskope AWS S3 bucket.</p></div></li><li class="step"><p>Change the region to US West (Oregon) (i.e., US-West-2).</p></li><li class="step"><p>In the AWS CloudFormation UI, click <span class="bold bold"><strong>Create stack</strong></span> and then <span class="bold bold"><strong>With new resources (standard)</strong></span>.</p><div class="mediaobject"><img src="image/uuid-2c808f98-332c-c612-a8d8-df08e4c1772b.png" style="" alt="image35.png"></img></div></li><li class="step"><p>Choose <span class="bold bold"><strong>Upload a template file</strong></span>, and click <span class="bold bold"><strong>Choose file</strong></span>.</p><div class="mediaobject"><img src="image/uuid-a712c771-933b-cf63-0f55-631d32aa763e.png" style="" alt="image36.png"></img></div></li><li class="step"><p>Select the <span class="bold bold"><strong>TGW_IPsec_management.yaml</strong></span> file, click <span class="bold bold"><strong>Open</strong></span>, and click <span class="bold bold"><strong>Next</strong></span>.</p><div class="mediaobject"><img src="image/uuid-ba4a70e3-9d32-a5c0-bb73-1a8e634abdd7.png" style="" alt="image37.png"></img></div></li><li class="step"><p>In <span class="bold bold"><strong>Specify stack details</strong></span>:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><span class="bold bold"><strong>Stack name</strong></span>: Enter a name for the stack.</p></li><li class="listitem"><p><span class="bold bold"><strong>Fallback</strong></span>: Choose <span class="bold bold"><strong>yes</strong></span> or <span class="bold bold"><strong>no</strong></span> if you want route fallback support for <span class="bold bold"><strong>TGWAttachmentID1</strong></span> when both of its IPSec tunnels became active after failure.</p></li><li class="listitem"><p><span class="bold bold"><strong>TGWAttachmentID1</strong></span>: Enter the ID of the transit gateway attachment for the primary VPN (e.g., tgw-attach-01234567890123456).</p></li><li class="listitem"><p><span class="bold bold"><strong>TGWAttachmentID2</strong></span>: Enter the ID of the transit gateway attachment for the failover VPN (e.g., tgw-attach-01234567890123456).</p></li><li class="listitem"><p><span class="bold bold"><strong>TGWID</strong></span>: Enter the ID of the AWS Transit Gateway (e.g., tgw-01234567890123456).</p></li><li class="listitem"><p><span class="bold bold"><strong>TGWName</strong></span>: Enter the AWS Transit Gateway name used for access control. All your transit gateway attachments must have an attribute <code class="literal">{"Key"="TGWName", "Value"="&lt;Transit Gateway Name&gt;"}</code>. For example, <code class="literal">{"Key"="TGWName", "NSTGW-us-east-1"}</code>.</p></li><li class="listitem"><p><span class="bold bold"><strong>TGWRegion</strong></span>: Choose the AWS region where you deployed your AWS Transit Gateway.</p></li></ul></div><div class="mediaobject"><img src="image/uuid-83ed7ebe-524b-4978-85fd-c1b1e2f784c7.png" style="" alt="image38.png"></img></div></li><li class="step"><p>Click <span class="bold bold"><strong>Next</strong></span>.</p></li><li class="step"><p>(Optional) Enter any tags for your stack, and click <span class="bold bold"><strong>Next</strong></span>.</p><div class="mediaobject"><img src="image/uuid-5fe6018f-e48f-cbf0-65a8-62bce44a80b4.png" style="" alt="image39.png"></img></div></li><li class="step"><p>Select <span class="bold bold"><strong>I acknowledge that AWS CloudFormation might create IAM resources</strong></span>, and click <span class="bold bold"><strong>Create stack</strong></span>.</p><div class="mediaobject"><img src="image/uuid-66f83a40-42c8-adea-86b4-b0139a9dedef.png" style="" alt="image40.png"></img></div></li></ol></div><p>When your configured CloudFormation stack status is <span class="bold bold"><strong>CREATE_COMPLETE</strong></span>, you can click the <span class="bold bold"><strong>Resources</strong></span> tab and see the resources the stack created.</p><div class="mediaobject"><img src="image/uuid-c9d29e67-fab1-aee3-2de5-1e46d78d3515.png" style="" alt="image41.png"></img></div><p>To monitor your AWS Lambda execution logs, in the AWS CloudWatch UI, go to <span class="bold bold"><strong>Logs</strong></span> &gt; <span class="bold bold"><strong>Log groups</strong></span> and select the log group for your AWS Lambda.</p><div class="mediaobject"><img src="image/uuid-50b5fab5-5bce-60a8-2c8e-c5635b13f629.png" style="" alt="image42.png"></img></div></div></div></section></section><div class="footer-content"><div class="section-toc section-toc-after"><div class="section-toc-title">In this section<span class="section-toc-title-delimiter">: </span></div></div><div class="glossary-definitions"></div></div><footer></footer></div></article><aside class="section-nav-container"><ul class="section-nav nav"><li><a href="#UUID-1c6d8fc8-71aa-ad02-3f0b-ef043b2b6921">Configure an IPSec Tunnel for an AWS Transit Gateway</a></li><li><a href="#UUID-1c6d8fc8-71aa-ad02-3f0b-ef043b2b6921_section-idm4554823043171232657271754817">Prerequisites</a></li><li><a href="#UUID-ee958858-31c5-34f8-1f33-a4e5860f1692">Configure an IPSec Tunnel for an AWS Transit Gateway</a></li><li><a href="#UUID-7085f65b-116f-9fd5-9345-38a6c3b48aec">Configure a Transit Gateway Route Table</a></li><li><a href="#UUID-189a72ab-b534-fde4-6405-c46668613fc0">Configure Failover Automation for the AWS Transit Gateway</a></li></ul></aside><article id="search-result-wrapper"><div class="search-container" style="display: none;"><h2>Search results</h2><ul class="searchresults"></ul><p class="noresults">No results found</p></div></article><div class="feedback-panel"><div id="email-feedback" class="no-voting toggle-feedback"><p><a href="mailto:techpubs@netskope.com?subject=Feedback%20for%20help%20topic%20%22Configure%20an%20IPSec%20Tunnel%20for%20an%20AWS%20Transit%20Gateway%22&amp;body=%0A%09%09%09%09%0A%09%09%09%09%0A%09%09%09%09_______________________%0A%09%09%09%09%0A%09%09%09Please%20add%20your%20feedback%20above%20for%20topic%20%22Configure%20an%20IPSec%20Tunnel%20for%20an%20AWS%20Transit%20Gateway%22%20in%20the%20publication%20%22Netskope%20Help%22."><i aria-hidden="true" class="fa fa-pencil-square-o feedbackicon"></i>Would you like to provide feedback? Just click here to suggest edits.</a></p></div></div></main><div id="bottom-pager"><ul class="pager"><li class="previous"><a accesskey="p" id="header-navigation-prev" class="pull-left prev visible-lg visible-md" href="configure-an-ipsec-tunnel-for-an-aws-virtual-private-gateway.html#UUID-a9b769af-5838-4a9b-5f74-8839ae299381_section-idm450121045012323265703194371">Prev</a></li><li class="next"><a accesskey="n" id="header-navigation-next" class="pull-right next visible-lg visible-md" href="configure-an-ipsec-tunnel-for-an-aws-transit-gateway.html#UUID-1c6d8fc8-71aa-ad02-3f0b-ef043b2b6921_section-idm4554823043171232657271754817">Next</a></li></ul></div><footer class="site-footer"><div class="inner"><div class="copyright"> © 2021 Netskope </div><div class="date-modified"><span class="date-modified-text">Last modified: </span><span class="formatted-date">September 30, 2021</span></div><div class="publication-date"><span class="publication-date-text">Publication date</span><span class="pubdate-delimiter">: </span><span class="formatted-date"></span></div></div></footer></div></div></div></div><!--Google Tag Manager (noscript)--><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W56WJ8S" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><!--End Google Tag Manager (noscript)--></body></html>
